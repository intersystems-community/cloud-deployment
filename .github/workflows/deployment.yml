name: Dev Cloud Deploy

on:
  workflow_call:
    inputs:
      name:
        description: 'Domain name of deployment, before `.sandbox.developer.intersystems.com`'
        required: true
        type: string
      memory:
        description: 'Memory for the instance'
        type: string
        default: 1Gi
      port:
        description: 'WebPort for the running instance'
        type: number
        default: 52773
      isc_data_directory:
        description: 'ISC_DATA_DIRECTORY environment variable value, e.g. /data (leave empty to skip)'
        type: string
        default: ''
    secrets:
      SERVICE_ACCOUNT_KEY:
        required: true
      CUSTOM_VARS_LIST:
        required: false
  workflow_dispatch:
    inputs:
      repository:
        description: 'Deploying repository'
        required: true
        type: string
      ref:
        description: 'Branch Name in deploying repository'
        required: true
        type: choice
        default: main
        options:
          - master
          - main
      name:
        description: 'Domain name of deployment, before `.sandbox.developer.intersystems.com`'
        required: true
        type: string

env:
  # Change this section according to your needs
  IMAGE_NAME:   ${{ inputs.name }}
  SERVICE:      ${{ inputs.name }}
  DOMAIN_NAME:  ${{ inputs.name }}.sandbox.developer.intersystems.com

# Leave this section untouched
  PROJECT_ID:     iris-community-demos
  CLUSTER_NAME:   demo
  GITHUB_SHA:     ${{ github.sha }}
  GITHUB_REPO:    ${{ github.repository }}
  REGION:         europe-west2
  NAMESPACE:      dev-cloud-workload
  SERVICE_PORT:   ${{ inputs.port }}
  SERVICE_MEMORY: ${{ inputs.memory }}
  HELM_URL:       https://charts.demo.community.intersystems.com
  HELM_REPO:      intersystems-charts
  HELM_VERSION:   0.0.1

jobs:
  deploy_workload:
    name: Deploy Workload
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.ref }}

    - name: Google Authentication
      uses: google-github-actions/auth@v3
      with:
        credentials_json: ${{ secrets.SERVICE_ACCOUNT_KEY }}

    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v3.0.0
      with:
        project_id:   ${{ env.PROJECT_ID }}
        cluster_name: ${{ env.CLUSTER_NAME }}
        location:     ${{ env.REGION }}

    - name: Setup gcloud cli
      uses: google-github-actions/setup-gcloud@v3.0.1
      with:
        version: '548.0.0'

    - name: Authorize Docker push
      run: |
        gcloud --quiet auth configure-docker ${REGION}-docker.pkg.dev

    - name: Build and Push image
      run: |
        docker buildx build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/community/${IMAGE_NAME}:${GITHUB_SHA} --push .

    - name: Prepare Helm Environment Variables
      id: prepare_helm_vars
      env:
        CUSTOM_VARS_RAW: ${{ secrets.CUSTOM_VARS_LIST }}
        ISC_DATA_DIR: ${{ inputs.isc_data_directory }}
      run: |
        CUSTOM_VARS_LIST_ESCAPED=""
        if [[ -n "${CUSTOM_VARS_RAW:-}" ]]; then
          CUSTOM_VARS_LIST_ESCAPED=$(echo "$CUSTOM_VARS_RAW" | sed -E 's/"/\\"/g')
        fi

        HELM_ARGS_STRING=""
        INDEX=0

        # Add ISC_DATA_DIRECTORY if provided
        if [[ -n "${ISC_DATA_DIR:-}" ]]; then
          echo "[INFO] Adding ISC_DATA_DIRECTORY=${ISC_DATA_DIR}"
          HELM_ARGS_STRING="$HELM_ARGS_STRING --set-string 'extraEnv[$INDEX].name=ISC_DATA_DIRECTORY' --set-string 'extraEnv[$INDEX].value=${ISC_DATA_DIR}'"
          INDEX=$((INDEX + 1))
        fi

        # Add GITHUB_REPO
        HELM_ARGS_STRING="$HELM_ARGS_STRING --set-string 'extraEnv[$INDEX].name=GITHUB_REPO' --set-string 'extraEnv[$INDEX].value=${GITHUB_REPO}'"
        INDEX=$((INDEX + 1))

        if [[ -n "${CUSTOM_VARS_LIST_ESCAPED:-}" ]]; then
          echo "[INFO] CUSTOM_VARS_LIST_ESCAPED contains data. Parsing key-values..."
          IFS=',' read -r -a ENV_PAIRS <<< "$CUSTOM_VARS_LIST_ESCAPED"

          for PAIR in "${ENV_PAIRS[@]}"; do
            # Skip empty pairs
            if [[ -z "$PAIR" ]]; then
              continue
            fi

            # Check if the pair contains '='
            if [[ "$PAIR" != *"="* ]]; then
              echo "[WARNING] Skipping malformed pair (no '='): '$PAIR'"
              continue
            fi

            # Split each pair into KEY and VALUE at the first '='
            KEY="${PAIR%%=*}"
            VALUE="${PAIR#*=}"
            echo "[INFO] Processing pair: '$PAIR' -> KEY='$KEY', VALUE='$VALUE'"

            # Only add if KEY is not empty (VALUE can be empty string)
            if [[ -n "$KEY" ]]; then
              HELM_ARGS_STRING="$HELM_ARGS_STRING --set-string 'extraEnv[$INDEX].name=$KEY' --set-string 'extraEnv[$INDEX].value=$VALUE'"
              INDEX=$((INDEX + 1))
            else
              echo "[WARNING] Skipping empty key: KEY='$KEY', VALUE='$VALUE'"
            fi
          done
        fi

        # Output the helm args string
        echo "helm_args=$HELM_ARGS_STRING" >> $GITHUB_OUTPUT

    - name: Deploy Stateful Workload
      run: |
        echo "[INFO] Set google project..."
        gcloud config set project ${PROJECT_ID}

        echo "[INFO] Installing IRIS Helm charts repository..."
        helm repo add intersystems-charts ${HELM_URL}

        echo "[INFO] Deploy Helm release..."
        helm upgrade --install ${{ inputs.name }} ${HELM_REPO}/iris-app \
            --namespace ${NAMESPACE} \
            --version ${HELM_VERSION} \
            --set image.repository=${REGION}-docker.pkg.dev/${PROJECT_ID}/community/${IMAGE_NAME} \
            --set image.tag=${GITHUB_SHA} \
            --set resources.limits.memory=${SERVICE_MEMORY:-1Gi} \
            --set service.webPort=${SERVICE_PORT:-52773} \
            --set ingress.name=${{ inputs.name }} \
            --set ingress.domain=${DOMAIN_NAME} \
            ${{ steps.prepare_helm_vars.outputs.helm_args }} \
            --wait \
            --atomic \
            --timeout 10m
